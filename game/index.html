<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Gear Wars - Battle Arena</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- YOUR ORIGINAL ARCADE STYLE - 100% UNCHANGED -->
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body, html {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #fff;
      overflow: hidden;
    }
    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 20px;
      width: 100%;
      max-width: 840px;
    }
    #gameCanvas {
      border: 4px solid #00d4ff;
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
      background: #0a0a15;
      border-radius: 10px;
      display: block;
    }
    .hud { display: flex; justify-content: space-between; width: 800px; max-width: 100%; gap: 20px; }
    .player-info {
      flex: 1;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid;
      transition: all 0.3s ease;
    }
    .player1-info { border-color: #00ff88; }
    .player2-info { border-color: #ff0088; }
    .hearts { display: flex; gap: 5px; margin: 10px 0; }
    .heart { width: 25px; height: 25px; font-size: 25px; }
    .stat-bar { margin: 8px 0; }
    .bar-container {
      width: 100%; height: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .bar-fill { height: 100%; transition: width 0.1s; border-radius: 10px; }
    .stamina-bar { background: linear-gradient(90deg, #00d4ff, #0088ff); }
    .heat-bar { background: linear-gradient(90deg, #ff6600, #ff0000); }

    .screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 100; backdrop-filter: blur(10px);
    }
    .hidden { display: none !important; }
    .screen h1 { font-size: 3.5em; margin-bottom: 20px; }
    .screen button {
      background: linear-gradient(45deg, #00d4ff, #0088ff);
      border: none; color: white; padding: 15px 40px;
      font-size: 1.4em; border-radius: 30px; cursor: pointer;
      margin: 10px; box-shadow: 0 10px 30px rgba(0,212,255,0.5);
    }

    /* MOBILE CONTROLS - FIXED & VISIBLE */
    #mobileControls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 20px; z-index: 99;
    }
    @media (min-width: 850px) { #mobileControls { display: none; } }
    .dpad { display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 10px; }
    #mobileControls button {
      width: 70px; height: 70px;
      background: rgba(0,212,255,0.9);
      border: none; border-radius: 50%;
      color: white; font-size: 28px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }
    #mobileControls button:active { transform: scale(0.9); }
    #up { grid-area: up; }
    #left { grid-area: left; }
    #right { grid-area: right; }
    #down { grid-area: down; }
    #gearBtn { background: #f1c40f; color: #000; }
  </style>
</head>
<body>

  <div id="gameContainer">
    <div class="hud">
      <div id="player1Info" class="player-info player1-info">
        <div>You</div>
        <div class="hearts" id="p1Hearts"></div>
      </div>
      <div style="font-size:2em;">VS</div>
      <div id="player2Info" class="player-info player2-info">
        <div>Enemy</div>
        <div class="hearts" id="p2Hearts"></div>
      </div>
    </div>
    <canvas id="gameCanvas"></canvas>
  </div>

  <!-- SCREENS -->
  <div id="startScreen" class="screen">
    <h1>GEAR WARS</h1>
    <p>Collect gears ‚Ä¢ Destroy enemy ‚Ä¢ Win coins</p>
    <button id="startBtn">START BATTLE</button>
  </div>

  <div id="gameOverScreen" class="screen hidden">
    <h1 id="resultTitle">VICTORY!</h1>
    <p id="resultMessage"></p>
    <button id="restartBtn">REMATCH</button>
    <button id="menuBtn">MENU</button>
  </div>

  <!-- MOBILE CONTROLS -->
  <div id="mobileControls">
    <div class="dpad">
      <button id="up">‚Üë</button>
      <button id="left">‚Üê</button>
      <button id="right">‚Üí</button>
      <button id="down">‚Üì</button>
    </div>
    <button id="gearBtn">Gear</button>
  </div>

  <script>

    // Add this at the top of your game script in index.html
const tg = window.Telegram.WebApp;

// WebSocket connection for multiplayer
function initializeWebSocket() {
    const isProduction = window.location.hostname !== 'localhost';
    const wsUrl = isProduction ? 'wss://gear-wars.onrender.com' : 'ws://localhost:10000';
    
    console.log('üîó Connecting to WebSocket:', wsUrl);
    
    // Your WebSocket connection logic here
}

// Check if we're in Telegram Web App
if (tg.initData) {
    console.log('‚úÖ Running in Telegram Web App');
    tg.expand();
    tg.ready();
    
    // Initialize game with Telegram user data
    initializeGameWithTelegramUser();
} else {
    console.log('üåê Running in standalone browser');
    initializeGameStandalone();
}
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    function resize() {
      const size = Math.min(800, window.innerWidth - 40, window.innerHeight - 200);
      canvas.width = canvas.height = size;
    }
    resize(); window.addEventListener('resize', resize);

    // GAME STATE
    let players = [], powerUps = [], particles = [];
    let gameTime = 60, gameRunning = false, lastTime = 0;
    let isMultiplayer = false, gameId = null, myIndex = 0;

    // MULTIPLAYER AUTO JOIN
    const urlParams = new URLSearchParams(location.search);
    gameId = urlParams.get('game');
    if (gameId) {
      isMultiplayer = true;
      document.getElementById('startScreen').style.display = 'none';
      // multiplayer.js will auto-connect
    }

    // SEND RESULT
    function sendResult(iWon) {
      const payload = isMultiplayer ? {
        type: 'game_result',
        gameId: gameId,
        winnerId: iWon ? tg.initDataUnsafe.user.id : 'opponent'
      } : {
        type: 'game_result',
        winner: iWon ? 'player' : 'ai'
      };
      tg.sendData(JSON.stringify(payload));
    }

    // YOUR ORIGINAL GAME CODE STARTS HERE (paste everything you already have below this line)
    // Just make sure you call: sendResult(true) on win, sendResult(false) on loss
    // And remove any old multiplayer code ‚Äî multiplayer.js handles it now

    // Example placeholder for your existing game loop (replace with your real code)
    function startGame() {
      gameRunning = true;
      lastTime = performance.now();
      // YOUR ORIGINAL startGame() code here
      requestAnimationFrame(gameLoop);
    }

    function gameLoop(time) {
      if (!gameRunning) return;
      const dt = (time - lastTime) / 1000;
      lastTime = time;

      // YOUR ORIGINAL game update/draw code here

      requestAnimationFrame(gameLoop);
    }

    function endGame(winnerIsMe) {
      gameRunning = false;
      document.getElementById('resultTitle').textContent = winnerIsMe ? 'VICTORY!' : 'DEFEAT!';
      document.getElementById('resultMessage').textContent = winnerIsMe ? 'You won the coins!' : 'Try again!';
      document.getElementById('gameOverScreen').classList.remove('hidden');
      sendResult(winnerIsMe);
    }

    // MOBILE CONTROLS
    const keys = {};
    ['up','down','left','right'].forEach(dir => {
      const btn = document.getElementById(dir);
      btn.addEventListener('touchstart', e => { e.preventDefault(); keys[dir] = true; });
      btn.addEventListener('touchend', e => { e.preventDefault(); keys[dir] = false; });
      btn.addEventListener('mousedown', () => keys[dir] = true);
      btn.addEventListener('mouseup', () => keys[dir] = false);
    });

    // BUTTONS
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('restartBtn').onclick = startGame;
    document.getElementById('menuBtn').onclick = () => tg.close();

    // AUTO START IF BET MATCH
    if (gameId) startGame();
  </script>

  <!-- MULTIPLAYER SCRIPT (must be last) -->
  <script src="multiplayer.js"></script>
</body>
</html>

